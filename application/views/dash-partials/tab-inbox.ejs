<div id="inbox-tab" class="container tab-pane active show" role="tabpanel">
    <br>
    <h2>Inbox</h2>
    <p>Here you will see messages from other users interested in your posts.</p>
    <hr style="border: 1px solid black">

    <div class="col-12 text-center mb-4">
        <select id="sortDropdownMsg" onchange="sortMessages()">
            <option value="">Sort By</option>
            <option value="dateAsc">Date: Oldest to Newest</option>
            <option value="dateDesc">Date: Newest to Oldest</option>
            <option value="alphaDesc">Alphabetical: A to Z</option>
            <option value="alphaAsc">Alphabetical: Z to A</option>
        </select>
    </div>

    <div class="row row-cols-1 row-cols-md-2 g-4" id="msgContainer">
        <% if (locals.messages && locals.messages.length> 0) { %>
            <% messages.forEach(function(message, index) { %>
                <div class="msg-container col-md-4" data-name="<%= message.itemName %>" data-date="<%= new Date(message.sendTime).toLocaleString() %>">
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            From: <%= message.senderName %>
                                <div id="timer_<%= message.messageId %>"></div>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">
                                <%= message.itemName %>
                            </h5>
                            <p class="card-text">Sent Time: <%= new Date(message.sendTime).toLocaleString() %>
                            </p>
                            <p class="card-text">Description:</p>
                            <p class="card-text text-truncate">
                                <%= message.content %>
                            </p>
                        </div>
                        <div class="card-footer">
                            <button type="button" class="btn btn-danger delete-msg" data-bs-toggle="modal"
                            <button type="button" class="btn btn-danger delete-msg" data-bs-toggle="modal"
                                data-target="#deleteMessageModal"
                                data-message-id="<%= message.messageId %>">Delete</button>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-target="#viewMessageModal" data-message-id="<%= message.messageId %>">View</button>
                        </div>
                    </div>
                </div>
                <% }) %>
                    <% } else { %>
                        <div class="m-auto">
                            <h3 class="display-4 my-5">You have no Mail</h3>
                        </div>
                        <% } %>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.delete-msg').forEach(button => {
        button.addEventListener('click', async (event) => {
            const messageId = event.target.getAttribute('data-message-id');

            // Confirm deletion with the user 
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    const response = await fetch(`/delete-message/${messageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert('Message deleted successfully');
                        // Remove the message from the DOM if the deletion is successful
                        event.target.closest('.msg-container').remove();
                    } else {
                        alert('Failed to delete the message');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the post');
                }
            }
        });
    });
});
</script>
<script>
    function sortMessages() {
        const dropdown = document.getElementById('sortDropdownMsg');
        const itemsContainer = document.getElementById('msgContainer');
        const items = Array.from(itemsContainer.getElementsByClassName('msg-container'));

        const sortBy = dropdown.value;

        items.sort((a, b) => {
            const dateA = new Date(a.getAttribute('data-date'));
            const dateB = new Date(b.getAttribute('data-date'));
            const nameA = a.getAttribute('data-name').toLowerCase();
            const nameB = b.getAttribute('data-name').toLowerCase();
            console.log("in inbox sort");
            switch (sortBy) {
                case 'dateAsc':
                    return dateA - dateB;
                case 'dateDesc':
                    return dateB - dateA;
                case 'alphaAsc':
                    return nameA.localeCompare(nameB);
                case 'alphaDesc':
                    return nameB.localeCompare(nameA);
                default:
                    return 0;
            }
        });

        itemsContainer.innerHTML = '';
        items.forEach(item => itemsContainer.appendChild(item));
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.delete-msg').forEach(button => {
        button.addEventListener('click', async (event) => {
            const messageId = event.target.getAttribute('data-message-id');

            // Confirm deletion with the user 
            if (confirm('Are you sure you want to delete this message?')) {
                try {
                    const response = await fetch(`/delete-message/${messageId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert('Message deleted successfully');
                        // Remove the message from the DOM if the deletion is successful
                        event.target.closest('.msg-container').remove();
                    } else {
                        alert('Failed to delete the message');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the post');
                }
            }
        });
    });
});
</script>