<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include('./partials/head') %>
    </head>
    <body class="d-flex flex-column vh-100">
        <%- include('./partials/nav') %>


        <!-- TODO : PASS EJS INFO TO MODAL POP UP-->
        <%- include('./partials/message') %>

        <h1>Results</h1>
        <p>
            <% if (isEmptyResult) { %>
                No results found for "<%= searchQuery %>", but here are some curated selections:
            <% } else { %>
                <%= items.length %> results for "<%= searchQuery %>"
            <% } %>
        </p>

        <main class="container mt-4">

            <div class="row row-cols-1 row-cols-md-3 g-4">
                <% items.forEach(item => { %>
                    <div class="col">
                        <div class="card h-100 m-auto" style="max-width: 18rem;">
                            <img src="<%= item.itemPicture %>" class="card-img-top" style="height: 150px; object-fit: cover;"
                                 alt="Image of <%= item.itemName %>">
                            <div class="card-body">
                                <h5 class="card-title"><%= item.itemName %></h5>
                                <% if (item.course) { %>
                                    <p class="card-text mb-0"><strong>Course:</strong> <%= item.course %></p>
                                <% } %>
                                <p class="card-text mb-0"><strong>Description:</strong> <%= item.itemDescription %></p>
                                <p class="card-text mb-0"><strong>Price:</strong> $<%= item.itemPrice %></p>
                                <!---<button type="button" class="btn btn-primary mt-3" onclick="window.location.href='/item-details/<%# item.postId %>'">View Details</button> -->
                                <button type="button" class="btn btn-primary mt-3 message-button" data-bs-toggle="modal" data-target="#messageModal" data-post-id="<%= item.postId %>">Message Seller</button>
                            </div>
                        </div>
                    </div>

                <% }); %>
            </div>
        </main>

        <script>
        document.addEventListener("DOMContentLoaded", function() {
            const messageButtons = document.querySelectorAll('.message-button');
            const modalBody = document.getElementById('modalBody');
            const closeButton = document.querySelector('.close'); // Select the close button

            messageButtons.forEach(function(button) {
                button.addEventListener("click", function() {
                    const postId = button.getAttribute('data-post-id');
                    fetch(`/message/${postId}`)
                        .then(response => response.json())
                        .then(postDetails => {
                            // Update modal content with data
                            let courseHTML = '';
                            if (postDetails.course) {
                                courseHTML = `<p class="card-text mb-3" id="courseDetails"><strong>Course:</strong> ${postDetails.course}</p>`;
                            }

                            modalBody.innerHTML = `
                                <div class="row">
                                    <div class="col-md-8">
                                        <h4 class="card-title" id="productName">${postDetails.itemName}</h4>
                                        <hr class="hr bg-dark">
                                        <img src="${postDetails.itemPicture}" alt="${postDetails.itemName} picture" class="img-thumbnail img-fluid" id="productImage" style="width: 300px; height: auto;">
                                        <div class="mb-3"></div>
                                        <p class="card-text mb-3" id="productDescription"><strong>Description:</strong> ${postDetails.itemDescription}</p>
                                        ${courseHTML}
                                        <p class="card-text mb-3" id="itemPrice"><strong>Price:</strong> $${postDetails.itemPrice}</p>
                                        <p class="card-text mb-3" id="pickupLocation"><strong>Pickup Location:</strong> ${postDetails.location}</p>
                                        <div class="form-group">
                                            <label class="fw-bold" for="message">Message:</label>
                                            <textarea class="form-control" id="message" name="message" rows="3" required placeholder="Type your message here..."></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-4 overflow-auto">
                                        <h4 class="card-title">Seller Information</h4>
                                        <hr class="hr bg-dark">
                                        <p class="mb-3" id="sellerName"><strong>Seller Name:</strong> ${postDetails.sellerName}</p>
                                        <p class="mb-3" id="sellerEmail"><strong>Contact Email:</strong> ${postDetails.sellerEmail}</p>
                                    </div>
                                </div>
                        `;
                            $('#messageModal').modal('show');
                        })
                        .catch(error => console.error('Error fetching post details:', error));
                });
            });
            // Add click event listener to the close button
            closeButton.addEventListener('click', function() {
                $('#messageModal').modal('hide'); // Hide the modal
            });
        });
        </script>
        
        <%- include('./partials/footer') %>
    </body>
</html>
